(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))o(t);new MutationObserver(t=>{for(const a of t)if(a.type==="childList")for(const m of a.addedNodes)m.tagName==="LINK"&&m.rel==="modulepreload"&&o(m)}).observe(document,{childList:!0,subtree:!0});function i(t){const a={};return t.integrity&&(a.integrity=t.integrity),t.referrerPolicy&&(a.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?a.credentials="include":t.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function o(t){if(t.ep)return;t.ep=!0;const a=i(t);fetch(t.href,a)}})();const S=document.getElementById("fileInput"),w=document.getElementById("generateRoomButton"),L=document.getElementById("joinRoomButton"),p=document.getElementById("roomNumberInput"),b=document.getElementById("initialView"),v=document.getElementById("fileTransferView"),E=document.getElementById("yourFilesList");document.getElementById("partnerFilesList");S.addEventListener("change",O);w.addEventListener("click",B);L.addEventListener("click",R);function B(){const e=k();I(e),p.value=e,C()}function R(){const e=p.value.trim();e?(I(e),C()):alert("Please enter a room number.")}function O(e){Array.from(e.target.files).slice(0,10).forEach(i=>{const o=new FileReader;o.onloadend=()=>{const t={name:i.name,data:o.result};localStorage.setItem("uploadedFile",JSON.stringify(t)),N(t,E),sendChannel.send(JSON.stringify(t))},o.readAsDataURL(i)})}function N(e,n){const i=document.createElement("li"),o=document.createElement("a");o.href=e.data,o.download=e.name,o.textContent=e.name,i.appendChild(o),n.appendChild(i)}function k(){return Math.random().toString(36).substring(2,11)}function h(){b.classList.add("hidden"),v.classList.remove("hidden")}let r,s,u,d,l,c;const F="wss://relay.drobilica.com:8080",D="turn:relay.drobilica.com:3478",T="forky",J="3kerQa28CjgX",y={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:D,username:T,credential:J}]};function P(){c=new WebSocket(F),c.onopen=()=>{console.log("WebSocket connection opened")},c.onerror=e=>{console.error("WebSocket error:",e)},c.onmessage=async e=>{const n=JSON.parse(await e.data.text());if(console.log("Received message: ",n),n.room!==l){console.warn(`Ignoring message for room ${n.room} in room ${l}`);return}switch(n.type){case"offer":U(n.offer);break;case"answer":x(n.answer);break;case"candidate":z(n.candidate);break;default:console.error("Unknown message type:",n.type)}}}function I(e){l=e}function C(){console.log("Initializing local connection"),r=new RTCPeerConnection(y),u=r.createDataChannel("sendDataChannel"),u.onopen=f,u.onclose=f,r.onicecandidate=e=>{e.candidate&&c.send(JSON.stringify({type:"candidate",candidate:e.candidate,room:l}))},r.createOffer().then(e=>r.setLocalDescription(e)).then(()=>{c.send(JSON.stringify({type:"offer",offer:r.localDescription,room:l}))})}function q(){console.log("Initializing remote connection"),s=new RTCPeerConnection(y),s.ondatachannel=A,s.onicecandidate=e=>{e.candidate&&c.send(JSON.stringify({type:"candidate",candidate:e.candidate,room:l}))}}function U(e){s||q(),s.setRemoteDescription(new RTCSessionDescription(e)).then(()=>s.createAnswer()).then(n=>s.setLocalDescription(n)).then(()=>{c.send(JSON.stringify({type:"answer",answer:s.localDescription,room:l}))})}function x(e){if(r.signalingState!=="have-local-offer"){console.error("Cannot set remote answer in state",r.signalingState);return}r.setRemoteDescription(new RTCSessionDescription(e)),h()}function z(e){const n=new RTCIceCandidate(e),i=r.signalingState!=="closed"?r:s;i&&i.signalingState!=="closed"&&i.addIceCandidate(n)}function f(e){u.readyState==="open"?(document.querySelector('label[for="fileInput"]').classList.remove("hidden"),document.getElementById("fileInput").classList.remove("hidden")):(document.querySelector('label[for="fileInput"]').classList.add("hidden"),document.getElementById("fileInput").classList.add("hidden"))}function A(e){d=e.channel,d.onmessage=j,d.onopen=g,d.onclose=g}function g(e){d.readyState==="open"?(document.querySelector('label[for="fileInput"]').classList.remove("hidden"),document.getElementById("fileInput").classList.remove("hidden"),h()):(document.querySelector('label[for="fileInput"]').classList.add("hidden"),document.getElementById("fileInput").classList.add("hidden"))}function j(e){const n=JSON.parse(e.data);V(n,document.getElementById("partnerFilesList"))}function V(e,n){const i=document.createElement("li"),o=document.createElement("a");o.href=e.data,o.download=e.name,o.textContent=e.name,i.appendChild(o),n.appendChild(i),document.getElementById("fileTradeBox").classList.remove("hidden")}P();

(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))c(o);new MutationObserver(o=>{for(const r of o)if(r.type==="childList")for(const u of r.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&c(u)}).observe(document,{childList:!0,subtree:!0});function a(o){const r={};return o.integrity&&(r.integrity=o.integrity),o.referrerPolicy&&(r.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?r.credentials="include":o.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function c(o){if(o.ep)return;o.ep=!0;const r=a(o);fetch(o.href,r)}})();const E="wss://relay.drobilica.com:8080",S="turn:relay.drobilica.com:3478",b="forky",B="3kerQa28CjgX",L={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:S,username:b,credential:B}]},v={ordered:!0,maxRetransmits:0},f=16384,O=document.getElementById("generateRoomBtn"),D=document.getElementById("roomCode"),F=document.getElementById("copyRoomUrlBtn"),N=document.getElementById("copyRoomIdBtn"),k=document.getElementById("joinRoomInput"),x=document.getElementById("joinRoomBtn"),U=document.getElementById("yourFileInput"),J=document.getElementById("yourFiles"),$=document.getElementById("theirFiles"),h=document.getElementById("roomDisplay");let t,s,l,i,p=[];function w(){l=new WebSocket(E),l.onopen=()=>{console.log("WebSocket connected"),l.send(JSON.stringify({type:"join",room:i})),console.log(`Joined room: ${i}`),R()},l.onmessage=async e=>{let n;try{const a=await e.data.text();n=JSON.parse(a)}catch(a){console.error("Failed to parse message as JSON:",e.data),console.error(a);return}n.type==="offer"?await T(n.offer):n.type==="answer"?await z(n.answer):n.type==="candidate"&&await A(n.candidate)},l.onerror=e=>{console.error("WebSocket error:",e)}}function R(){console.log("Initializing peer connection"),t=new RTCPeerConnection(L),s=t.createDataChannel("fileTransfer",v),g(),t.ondatachannel=e=>{s=e.channel,g()},t.onicecandidate=e=>{e.candidate&&l.send(JSON.stringify({type:"candidate",candidate:e.candidate,room:i}))},j()}function g(){s.onopen=()=>{for(console.log("Data channel open");p.length>0;){const e=p.shift();sendFile(e)}},s.onclose=()=>{console.log("Data channel closed")},s.onerror=e=>{console.error("Data channel error:",e)},s.onmessage=P}function P(e){const n=JSON.parse(e.data);n.type==="file"&&q(n)}async function j(){try{const e=await t.createOffer();await t.setLocalDescription(e),l.send(JSON.stringify({type:"offer",offer:t.localDescription,room:i}))}catch(e){console.error("Error creating offer:",e)}}async function T(e){t||R();try{t.signalingState!=="stable"&&(console.warn("Peer connection state is not stable, resetting..."),await t.setLocalDescription({type:"rollback"})),await t.setRemoteDescription(new RTCSessionDescription(e));const n=await t.createAnswer();await t.setLocalDescription(n),l.send(JSON.stringify({type:"answer",answer:t.localDescription,room:i}))}catch(n){console.error("Error handling offer:",n)}}async function z(e){try{t.signalingState==="have-local-offer"?await t.setRemoteDescription(new RTCSessionDescription(e)):console.warn("Received answer in unexpected state:",t.signalingState)}catch(n){console.error("Error handling answer:",n)}}async function A(e){try{await t.addIceCandidate(new RTCIceCandidate(e))}catch(n){console.error("Error adding received ICE candidate",n)}}function W(e){const n=e.target.files[0];M(n)}function M(e){const n=new FileReader;let a=0;n.onload=()=>{if(s&&s.readyState==="open"){const o=n.result;s.send(JSON.stringify({type:"file",name:e.name,chunk:o,size:e.size})),C({name:e.name,data:o},J),a+=f,a<e.size?c(a):console.log("File sent successfully")}else console.log("Data channel is not open, queuing file"),p.push(e)};function c(o){const r=e.slice(o,o+f);n.readAsArrayBuffer(r)}c(0)}let d=[],m="";function q(e){if(m||(m=e.name),d.push(e.chunk),d.length*f>=e.size){const n=new Blob(d);C({name:m,data:URL.createObjectURL(n)},$),d=[],m=""}}function C(e,n){const a=document.createElement("li"),c=document.createElement("a");c.href=e.data,c.download=e.name,c.textContent=e.name,a.appendChild(c),n.appendChild(a);const o=document.createElement("button");o.textContent="Download",o.className="bg-blue-500 text-white px-2 py-1 rounded ml-2",o.addEventListener("click",()=>{const r=document.createElement("a");r.href=e.data,r.download=e.name,r.click()}),a.appendChild(o)}function K(){h.textContent=`Joined Room: ${i}`;const e=`${window.location.origin}/trade?room=${i}`;navigator.clipboard.writeText(e).then(()=>console.log("Room URL copied!")),console.log(`Copied room URL: ${e}`)}function I(e){console.log(`Joining room: ${e}`),h.textContent=`Joined Room: ${e}`,w()}O.addEventListener("click",()=>{i=Math.random().toString(36).substring(2,10),D.value=i,console.log(`Generated room: ${i}`),K(),w()});F.addEventListener("click",()=>{const e=`${window.location.origin}/trade?room=${i}`;navigator.clipboard.writeText(e).then(()=>console.log("Room URL copied!")),console.log(`Copied room URL: ${e}`)});N.addEventListener("click",()=>{navigator.clipboard.writeText(i).then(()=>console.log("Room ID copied!")),console.log(`Copied room ID: ${i}`)});x.addEventListener("click",()=>{const e=k.value.trim();e&&(i=e,I(i))});U.addEventListener("change",W);const G=new URLSearchParams(window.location.search),y=G.get("room");y&&(i=y,I(i));

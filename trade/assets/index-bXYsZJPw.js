(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const m of r.addedNodes)m.tagName==="LINK"&&m.rel==="modulepreload"&&s(m)}).observe(document,{childList:!0,subtree:!0});function i(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(n){if(n.ep)return;n.ep=!0;const r=i(n);fetch(n.href,r)}})();const B="wss://relay.drobilica.com:8080",L="turn:relay.drobilica.com:3478",v="forky",P="3kerQa28CjgX",D={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:L,username:v,credential:P}]},O={ordered:!0,maxRetransmits:0},f=16384,F=4e3,x=document.getElementById("generateRoomBtn"),N=document.getElementById("roomCode"),k=document.getElementById("copyRoomUrlBtn"),U=document.getElementById("copyRoomIdBtn"),$=document.getElementById("joinRoomInput"),J=document.getElementById("joinRoomBtn"),T=document.getElementById("yourFileInput"),j=document.getElementById("yourFiles"),z=document.getElementById("theirFiles"),R=document.getElementById("roomDisplay"),p=document.getElementById("uploadProgressContainer"),A=document.getElementById("uploadProgress"),M=document.getElementById("uploadProgressPercent");let t,l,c,a,g=[],y=0;function I(){c=new WebSocket(B),c.onopen=()=>{console.log("WebSocket connected"),c.send(JSON.stringify({type:"join",room:a})),console.log(`Joined room: ${a}`),E()},c.onmessage=async e=>{let o;try{const i=await e.data.text();o=JSON.parse(i)}catch(i){console.error("Failed to parse message as JSON:",e.data),console.error(i);return}o.type==="offer"?await q(o.offer):o.type==="answer"?await G(o.answer):o.type==="candidate"&&await K(o.candidate)},c.onerror=e=>{console.error("WebSocket error:",e)}}function E(){console.log("Initializing peer connection"),t=new RTCPeerConnection(D),l=t.createDataChannel("fileTransfer",O),h(),t.ondatachannel=e=>{l=e.channel,h()},t.onicecandidate=e=>{e.candidate&&c.send(JSON.stringify({type:"candidate",candidate:e.candidate,room:a}))},_()}function h(){l.onopen=()=>{for(console.log("Data channel open");g.length>0;){const e=g.shift();sendFile(e)}},l.onclose=()=>{console.log("Data channel closed")},l.onerror=e=>{console.error("Data channel error:",e)},l.onmessage=W}function W(e){const o=JSON.parse(e.data);o.type==="file"&&X(o)}async function _(){try{const e=await t.createOffer();await t.setLocalDescription(e),c.send(JSON.stringify({type:"offer",offer:t.localDescription,room:a}))}catch(e){console.error("Error creating offer:",e)}}async function q(e){t||E();try{t.signalingState!=="stable"&&(console.warn("Peer connection state is not stable, resetting..."),await t.setLocalDescription({type:"rollback"})),await t.setRemoteDescription(new RTCSessionDescription(e));const o=await t.createAnswer();await t.setLocalDescription(o),c.send(JSON.stringify({type:"answer",answer:t.localDescription,room:a}))}catch(o){console.error("Error handling offer:",o)}}async function G(e){try{t.signalingState==="have-local-offer"?await t.setRemoteDescription(new RTCSessionDescription(e)):console.warn("Received answer in unexpected state:",t.signalingState)}catch(o){console.error("Error handling answer:",o)}}async function K(e){try{await t.addIceCandidate(new RTCIceCandidate(e))}catch(o){console.error("Error adding received ICE candidate",o)}}function H(e){const o=e.target.files[0];Q(o)}function Q(e){const o=new FileReader;let i=0;p.classList.remove("hidden"),w(0),o.onload=()=>{if(l&&l.readyState==="open"){const n=o.result;l.send(JSON.stringify({type:"file",name:e.name,chunk:n,size:e.size})),S({name:e.name,data:n},j),i+=f,w(Math.min(i/e.size*100,100)),i<e.size?s(i):(console.log("File sent successfully"),p.classList.add("hidden"))}else console.log("Data channel is not open, queuing file"),g.push(e)};function s(n){const r=e.slice(n,n+f);o.readAsArrayBuffer(r)}s(0)}function w(e){A.value=e,M.textContent=`${e.toFixed(2)}%`}let d=[],u="";function X(e){if(u||(u=e.name),d.push(e.chunk),d.length*f>=e.size){const o=new Blob(d);S({name:u,data:URL.createObjectURL(o)},z),d=[],u=""}}function S(e,o){const i=document.createElement("li"),s=document.createElement("a");s.href=e.data,s.download=e.name,s.textContent=e.name,i.appendChild(s),o.appendChild(i);const n=document.createElement("button");n.textContent="Download",n.className="bg-blue-500 text-white px-2 py-1 rounded ml-2",n.addEventListener("click",()=>{const r=document.createElement("a");r.href=e.data,r.download=e.name,r.click()}),i.appendChild(n)}function Z(){R.textContent=`Joined Room: ${a}`;const e=`${window.location.origin}/trade?room=${a}`;navigator.clipboard.writeText(e).then(()=>console.log("Room URL copied!")),console.log(`Copied room URL: ${e}`)}function b(e){console.log(`Joining room: ${e}`),R.textContent=`Joined Room: ${e}`,I()}x.addEventListener("click",()=>{const e=Date.now();e-y>=F?(t&&(t.close(),t=null),c&&(c.close(),c=null),a=Math.random().toString(36).substring(2,10),N.value=a,console.log(`Generated room: ${a}`),Z(),I(),y=e):console.log("Please wait before generating a new room.")});k.addEventListener("click",()=>{const e=`${window.location.origin}/trade?room=${a}`;navigator.clipboard.writeText(e).then(()=>console.log("Room URL copied!")),console.log(`Copied room URL: ${e}`)});U.addEventListener("click",()=>{navigator.clipboard.writeText(a).then(()=>console.log("Room ID copied!")),console.log(`Copied room ID: ${a}`)});J.addEventListener("click",()=>{const e=$.value.trim();e&&(a=e,b(a))});T.addEventListener("change",H);const V=new URLSearchParams(window.location.search),C=V.get("room");C&&(a=C,b(a));
